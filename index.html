<script>
    // Google Sheets public URL
    const SHEET_ID = '1rz53WitPQyR8tw_6zgQOLc_Qs3h7ZhMVvWyGtrgu1lI';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

    async function fetchHabitData() {
        const statusEl = document.getElementById('status-message');

        try {
            const response = await fetch(SHEET_URL);
            const text = await response.text();

            // Google Sheets returns JSONP, need to parse it
            const jsonText = text.substring(47, text.length - 2);
            const data = JSON.parse(jsonText);

            // Convert to dateMap
            const dateMap = {};
            data.table.rows.forEach(row => {
                if (row.c[0] && row.c[1]) {
                    const date = row.c[0].v; // date
                    const count = row.c[1].v; // count
                    dateMap[date] = count;
                }
            });

            statusEl.textContent = 'Data loaded';
            setTimeout(() => statusEl.style.opacity = '0', 3000);

            return dateMap;
        } catch (error) {
            console.error('Fetch error:', error);
            statusEl.textContent = 'Error loading data: ' + error.message;
            statusEl.classList.add('error');
            return null;
        }
    }

    function renderChart(dateMap) {
        if (!dateMap) return;

        const chartEl = document.getElementById('chart');
        chartEl.innerHTML = '';

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // Start from the Monday of the week 52 weeks ago
        const startDate = new Date(today);
        startDate.setDate(today.getDate() - 364);
        while (startDate.getDay() !== 1) {
            startDate.setDate(startDate.getDate() - 1);
        }

        // Count total habits
        let totalHabits = 0;
        for (let date in dateMap) {
            totalHabits += dateMap[date];
        }
        document.getElementById('contribution-count').textContent = totalHabits;

        // Generate 53 weeks
        const currentDate = new Date(startDate);
        for (let w = 0; w < 53; w++) {
            const weekEl = document.createElement('div');
            weekEl.className = 'week';

            for (let d = 0; d < 7; d++) {
                const cell = document.createElement('div');
                cell.className = 'cell';

                const dateStr = currentDate.toISOString().split('T')[0];
                const count = dateMap[dateStr] || 0;

                if (count > 0) {
                    const level = Math.min(4, count);
                    cell.setAttribute('data-level', level);
                }

                // Tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                const dateFormatted = currentDate.toLocaleDateString(undefined, {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                tooltip.textContent = `${count} habits on ${dateFormatted}`;
                cell.appendChild(tooltip);

                weekEl.appendChild(cell);
                currentDate.setDate(currentDate.getDate() + 1);

                if (currentDate > today && w === 52) break;
            }
            chartEl.appendChild(weekEl);
        }
    }

    // Load and render
    fetchHabitData().then(renderChart);
</script>